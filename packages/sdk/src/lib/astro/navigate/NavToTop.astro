---
import type { HTMLAttributes } from 'astro/types';
import twMerge from '../../tailwind/tailwind-merge';
import Icon from '../icon/Icon.astro';
import type { IconsKeys } from '../icon';

type Props = Omit<HTMLAttributes<'button'>, 'class'> & {
  class?: ClassName;
  icon?: IconsKeys;
  label?: string;
  duration?: number;
  speed?: number;
};

const {
  class: className,
  icon = 'arrow-fat-lines-up-duotone',
  label = 'to top',
  duration = 300,
  speed: __speed,
  ...props
} = Astro.props;

const speed = __speed ?? duration * 5;
---

<button
  is='app-to-top'
  class={twMerge(
    'flex absolute top-full z-10 w-10',
    'disabled scale-0 origin-center opacity-50 hover:opacity-100',
    'onscroll:enabled onscroll:scale-100',
    'transition-transform delay-150 ease-in-out dura',
    className
  )}
  style={`transition-duration: ${duration}ms`}
  aria-label={label}
  data-speed={speed}
  {...props}>
  <slot>
    <Icon
      {icon}
      class='disabled h-auto w-full'
    />
  </slot>
</button>

<script>
  import { toTop } from '../../utils/scroll';

  class AppToTop extends HTMLButtonElement {
    constructor() {
      super();
    }

    get speed() {
      return this.dataset.speed ? parseInt(this.dataset.speed) : 1000;
    }

    connectedCallback() {
      this.addEventListener('click', this.handle);
    }

    // disconnectedCallback() { this.removeEventListener('click', this.handle); }

    handle = (ev: Event) => {
      ev.preventDefault();
      ev.stopPropagation();
      toTop({ duration: this.speed });
    };
  }

  customElements.define('app-to-top', AppToTop, { extends: 'button' });
</script>
