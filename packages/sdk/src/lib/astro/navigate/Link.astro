---
// import type { HTMLAttributes } from 'astro/types';
import twMerge from '../../tailwind/tailwind-merge';
import type { NavItem as Props } from '.';

/*
type Props = Omit<HTMLAttributes<'a'>, 'class'> & {
  class?: ClassName;
  label?: string;
};
*/

const { class: className, href, label, ...props } = Astro.props;

const current =
  Astro.url.pathname === href || Astro.url.pathname === `${href}/`
    ? 'page'
    : Astro.url.pathname.indexOf(`${href}/`) >= 0
    ? 'step'
    : undefined;
---

<a
  is='app-link'
  class={twMerge(className)}
  {href}
  aria-label={Astro.slots.has('default') ? label : undefined}
  aria-current={current}
  {...props}>
  <slot name='before' />
  <slot>
    <Fragment set:html={label} />
  </slot>
  <slot name='after' />
</a>

<script>
  import { page } from '../../app/stores';

  class AppLink extends HTMLAnchorElement {
    constructor() {
      super();
    }

    connectedCallback() {
      document.addEventListener('astro:page-load', this.check, { once: true });
      document.addEventListener('astro:after-swap', this.check, { once: true });
    }

    // disconnectedCallback() {  }

    set current(val: string | undefined) {
      val ? this.setAttribute('aria-current', val) : this.removeAttribute('aria-current');
    }

    check = () => {
      const pathname = page.get().url.pathname;
      this.current =
        pathname === this.pathname || pathname === `${this.pathname}/`
          ? 'page'
          : pathname?.indexOf(`${this.pathname}/`) >= 0
          ? 'step'
          : undefined;
    };
  }

  customElements.define('app-link', AppLink, { extends: 'a' });
</script>
