---
import type { HTMLAttributes } from 'astro/types';
import twMerge from '../../tailwind/tailwind-merge';
import Link from '../navigate/Link.astro';
import NavbarDropdown from './NavbarDropdown.astro';
import type { NavItem } from '../navigate';

type Props = Omit<HTMLAttributes<'nav'>, 'class'> & {
  class?: ClassName;
  custom?: Record<string, ClassName>;
  items: NavItem[];
};
const { class: className, custom = {}, items, ...props } = Astro.props;
---

<nav
  is='app-navbar-menu'
  id='app-navbar-menu'
  class={twMerge(
    'absolute left-0 top-full z-0 lg:static',
    // 'grid grid-cols-1 lg:auto-cols-max lg:grid-flow-col lg:gap-x-3 2xl:gap-x-5',
    'flex flex-col lg:flex-row lg:flex-nowrap',
    // 'lg:gap-x-2 2xl:gap-x-4',
    'ml-1 mt-1 max-w-xs sm:max-w-md lg:m-0 lg:max-w-none lg:h-full',
    'aria-hidden:disabled aria-hidden:scale-75 aria-hidden:opacity-0',
    'origin-top-left transition lg:origin-center',
    '-lg:overflow-hidden',
    custom.menu,
    className
  )}
  style='transition-duration: 0ms;'
  aria-owns='app-navbar-toggle'
  {...props}>
  {
    items.map(({ href, label, items }) =>
      items ? (
        <NavbarDropdown
          rel='prefetch'
          {custom}
          {href}
          {label}
          {items}
        />
      ) : (
        <Link
          rel='prefetch'
          class={['flex items-center align-middle', custom.item, custom.link]}
          {href}>
          {label}
        </Link>
      )
    )
  }
  <slot />
</nav>

<script is:inline>
  const node = document.getElementById('app-navbar-menu');
  if (node && window.innerWidth < 1024) {
    node.setAttribute('aria-hidden', 'true');
    node.querySelectorAll('a').forEach((el) => el.setAttribute('tabindex', '-1'));
  }
</script>

<script>
  import { status } from '../../app/stores';

  class AppNavbarMenu extends HTMLElement {
    constructor() {
      super();

      this.style.transitionDuration = '0ms';
      this.hidden = this.check();
      status.listen((val, key) => {
        if (key === 'navbar.hidden') {
          this.hidden = !!val.navbar.hidden;
        }
      });
    }

    connectedCallback() {
      window.addEventListener('resize', this.check);
      document.addEventListener('astro:page-load', this.reset);
      document.addEventListener('click', this.handleOutside);
    }

    disconnectedCallback() {
      window.removeEventListener('resize', this.check);
      document.removeEventListener('astro:page-load', this.reset);
      document.removeEventListener('click', this.handleOutside);
    }

    actives = this.querySelectorAll('a, button, [role="button"]');

    get hidden() {
      return this.getAttribute('aria-hidden') === 'true';
    }

    set hidden(val) {
      if (val) {
        this.setAttribute('aria-hidden', 'true');
        this.actives.forEach((el) => el.setAttribute('tabindex', '-1'));
      } else {
        this.removeAttribute('aria-hidden');
        this.actives.forEach((el) => el.removeAttribute('tabindex'));
      }
    }

    check = () => {
      const hidden = window.innerWidth < 1024;
      status.setKey('navbar.hidden', hidden);
      return hidden;
    };

    reset = () => {
      this.check();
      setTimeout(() => (this.style.transitionDuration = '300ms'), 150);
    };

    get owner() {
      const id = this.getAttribute('aria-owns');
      return id ? document.getElementById(id) : null;
    }

    handleOutside = (ev: Event) => {
      if (
        ev?.target &&
        // !ev.defaultPrevented &&
        !this.contains(ev.target as Node) &&
        !this.owner?.contains(ev.target as Node)
      )
        this.check();
    };
  }

  customElements.define('app-navbar-menu', AppNavbarMenu, { extends: 'nav' });
</script>
